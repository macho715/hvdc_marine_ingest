name: Marine Weather Hourly Collection

on:
  schedule:
    - cron: '7 * * * *'          # UTC, ì •ê° í˜¼ì¡ íšŒí”¼ (ê¶Œì¥)
  workflow_dispatch: {}

env:
  NOTIFY_TELEGRAM: '1'
  NOTIFY_EMAIL: '1'

jobs:
  marine-weather:
    runs-on: ubuntu-latest
    
    # âœ… ì›Œí¬í”Œë¡œìš° ê¶Œí•œ ì„¤ì • (ì‹œí¬ë¦¿ ì ‘ê·¼ ê¶Œí•œ ëª…ì‹œ)
    permissions:
      contents: read
      actions: read
      secrets: read

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install deps
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Seleniumì„ ìœ„í•œ ì‹œìŠ¤í…œ ì˜ì¡´ì„±
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

    - name: Compute timestamp (UTC)
      id: now
      run: echo "utc=$(date -u '+%Y-%m-%d %H:%M UTC')" >> "$GITHUB_OUTPUT"

    # âœ… ê²Œì´íŠ¸ ìŠ¤í…: secrets ë³´ìœ  ì—¬ë¶€ë¥¼ ë¶ˆë¦° ì¶œë ¥ìœ¼ë¡œ ê³„ì‚° (ì‹œí¬ë¦¿ ì§ì ‘ ë¹„êµ ë¬¸ì œ í•´ê²°)
    - name: Compute gates
      id: gates
      run: |
        echo "has_tg=${{ secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != '' }}" >> "$GITHUB_OUTPUT"
        echo "has_mail=${{ secrets.MAIL_USERNAME != '' && secrets.MAIL_PASSWORD != '' && secrets.MAIL_TO != '' }}" >> "$GITHUB_OUTPUT"
        echo "has_apis=${{ secrets.STORMGLASS_API_KEY != '' || secrets.WORLDTIDES_API_KEY != '' }}" >> "$GITHUB_OUTPUT"
        
        # ì‹œí¬ë¦¿ ìƒíƒœ ì§„ë‹¨ ì¶œë ¥ (*** ë§ˆìŠ¤í‚¹ìœ¼ë¡œ ë³´ì•ˆ ìœ ì§€)
        echo "ğŸ” ì‹œí¬ë¦¿ ìƒíƒœ ì§„ë‹¨:"
        echo "  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        echo "  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        echo "  MAIL_USERNAME: ${{ secrets.MAIL_USERNAME != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        echo "  MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        echo "  MAIL_TO: ${{ secrets.MAIL_TO != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        echo "  STORMGLASS_API_KEY: ${{ secrets.STORMGLASS_API_KEY != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        echo "  WORLDTIDES_API_KEY: ${{ secrets.WORLDTIDES_API_KEY != '' && 'ì„¤ì •ë¨' || 'ì—†ìŒ' }}"
        
    - name: Run marine weather collection
      run: |
        set -eo pipefail
        mkdir -p out
        python scripts/weather_job.py --location "AGI" --hours 24 --out out

    # âœ… TXT ì—†ìœ¼ë©´ HTMLâ†’TXT í´ë°± ìƒì„±
    - name: Ensure summary.txt exists
      run: |
        if [ ! -f out/summary.txt ] && [ -f out/summary.html ]; then
          # ë§¤ìš° ë‹¨ìˆœ ë³€í™˜: íƒœê·¸ ì œê±°
          sed -E 's/<[^>]*>//g' out/summary.html | sed 's/&nbsp;/ /g' > out/summary.txt
        fi
        ls -l out || true
        
    # âœ… í…”ë ˆê·¸ë¨: 4096ì ì´ˆê³¼ ì‹œ sendDocumentë¡œ ìë™ ì „í™˜, ì‹¤íŒ¨ì‹œ ë¡œê·¸ ë‚¨ê¹€
    - name: Telegram notify (text or document)
      if: ${{ steps.gates.outputs.has_tg == 'true' }}
      env:
        TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        set -eo pipefail
        if [ ! -f out/summary.txt ] && [ ! -f out/summary.html ]; then
          echo "::warning::No summary files; skip Telegram."
          exit 0
        fi

        # ê¸¸ì´ í™•ì¸(ë°”ì´íŠ¸ ê¸°ì¤€ ëŸ¬í”„ì²´í¬)
        BYTES=$( [ -f out/summary.txt ] && wc -c < out/summary.txt || echo 0 )
        if [ "$BYTES" -gt 4000 ] && [ -f out/summary.html ]; then
          echo "Message >4096 bytes â†’ sendDocument"
          curl -fsS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT}" \
            -F caption="Marine Weather â€” ${{ steps.now.outputs.utc }}" \
            -F document=@out/summary.html \
            -o .tg_resp.json
        else
          curl -fsS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TG_CHAT}" \
            --data-urlencode "disable_web_page_preview=true" \
            --data-urlencode "parse_mode=HTML" \
            --data-urlencode "text@out/summary.txt" \
            -o .tg_resp.json
        fi
        echo "Telegram response:"; cat .tg_resp.json
        # ì‹¤íŒ¨ì‹œ curl -f ë•ë¶„ì— ì—¬ê¸° ëª» ì˜´

    - name: Email notify (Gmail SMTP via action)
      if: ${{ steps.gates.outputs.has_mail == 'true' }}
      uses: dawidd6/action-send-mail@v6
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.MAIL_USERNAME }}     # Gmail ì£¼ì†Œ
        password: ${{ secrets.MAIL_PASSWORD }}     # âœ… Google App Password í•„ìš”
        subject: "ğŸŒŠ Marine Weather Report - AGI - ${{ steps.now.outputs.utc }}"
        to: ${{ secrets.MAIL_TO }}
        from: "HVDC Weather Bot <${{ secrets.MAIL_USERNAME }}>"
        html_body: file://out/summary.html

    # âœ… ì‹œí¬ë¦¿ ì§„ë‹¨ ìŠ¤í… (ì‹œí¬ë¦¿ "ì‚¬ë¼ì§" ë¬¸ì œ í•´ê²°)
    - name: Telegram ping (secrets validation)
      if: ${{ steps.gates.outputs.has_tg == 'true' }}
      run: |
        echo "ğŸ” Telegram ì‹œí¬ë¦¿ ê²€ì¦ ì‹œì‘..."
        
        # 1. Bot Token ìœ íš¨ì„± í™•ì¸
        echo "ğŸ“¡ Bot Token ê²€ì¦ ì¤‘..."
        BOT_INFO=$(curl -fsS "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/getMe")
        echo "Bot Info: $BOT_INFO"
        
        # 2. Chat ID ê¶Œí•œ í™•ì¸
        echo "ğŸ“± Chat ID ê²€ì¦ ì¤‘..."
        curl -fsS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          --data-urlencode "text=ğŸ” HVDC Marine Weather System - ì‹œí¬ë¦¿ ê²€ì¦ ì„±ê³µ ${{ steps.now.outputs.utc }}" \
          --data-urlencode "parse_mode=HTML" \
          -o .tg_ping_response.json
        
        echo "âœ… Telegram ì‹œí¬ë¦¿ ê²€ì¦ ì™„ë£Œ"
        echo "Response: $(cat .tg_ping_response.json)"

    - name: Upload artifacts (optional)
      uses: actions/upload-artifact@v4
      with:
        name: marine-weather-${{ github.run_number }}
        path: out/*
        if-no-files-found: ignore
        retention-days: 7
