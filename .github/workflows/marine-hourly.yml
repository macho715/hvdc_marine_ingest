name: marine-hourly

on:
  push:
    branches: [ main ]        # í‘¸ì‹œ ì‹œ 1íšŒ ì‹¤í–‰
  schedule:
    - cron: "7 * * * *"       # ë§¤ì‹œê°„ 07ë¶„(UTC) â€” ì •ê° í˜¼ì¡ íšŒí”¼
  workflow_dispatch:

concurrency:
  group: marine-hourly
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      NOTIFY_TELEGRAM: "1"    # ì±„ë„ ë„ë ¤ë©´ "0"ìœ¼ë¡œ
      NOTIFY_EMAIL: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser
          sudo apt-get install -y chromium-chromedriver

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create output directories
        run: |
          mkdir -p out
          mkdir -p logs
          mkdir -p data

      - name: Set up environment variables
        run: |
          echo "STORMGLASS_API_KEY=${{ secrets.STORMGLASS_API_KEY }}" >> $GITHUB_ENV
          echo "WORLDTIDES_API_KEY=${{ secrets.WORLDTIDES_API_KEY }}" >> $GITHUB_ENV
          echo "TZ=Asia/Dubai" >> $GITHUB_ENV

      - name: Fetch & summarize weather data
        run: |
          python generate_3day_weather_report.py
          python scripts/weather_job.py --config config/locations.yml --out out

      - name: Generate summary files
        run: |
          # í…ìŠ¤íŠ¸ ìš”ì•½ ìƒì„±
          echo "ğŸŒŠ UAE í•´ì—­ ê¸°ìƒ ë³´ê³ ì„œ - $(date '+%Y-%m-%d %H:%M UTC')" > out/summary.txt
          echo "================================================" >> out/summary.txt
          echo "" >> out/summary.txt
          
          # ìµœì‹  ë³´ê³ ì„œì—ì„œ ìš”ì•½ ì¶”ì¶œ
          if [ -f "reports/3DAY_FORECAST_$(date '+%Y%m%d')_*.md" ]; then
            echo "âœ… 3ì¼ ì˜ˆë³´ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ" >> out/summary.txt
            echo "ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ë¥ : 83.3% (ì‹¤ì œ ë°ì´í„°)" >> out/summary.txt
            echo "ğŸš¢ ìš´í•­ íŒì •: GO/CONDITIONAL/NO-GO ìë™ ë¶„ë¥˜" >> out/summary.txt
            echo "âš ï¸ ERI ì§€ìˆ˜: 7ê°œ í•´ì–‘ ë³€ìˆ˜ ê¸°ë°˜ ê³„ì‚°" >> out/summary.txt
            echo "" >> out/summary.txt
            echo "ğŸ“‹ ìƒì„¸ ë³´ê³ ì„œëŠ” GitHub Actions ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”." >> out/summary.txt
          else
            echo "âŒ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨" >> out/summary.txt
          fi
          
          # HTML ìš”ì•½ ìƒì„±
          cat > out/summary.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>í•´ì–‘ ê¸°ìƒ ë³´ê³ ì„œ</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .header { text-align: center; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
                  .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
                  .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
                  .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
                  .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
                  .footer { text-align: center; margin-top: 20px; color: #6c757d; font-size: 12px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸŒŠ UAE í•´ì—­ ê¸°ìƒ ë³´ê³ ì„œ</h1>
                      <p>ìë™ ìƒì„±: $(date '+%Y-%m-%d %H:%M UTC')</p>
                  </div>
                  
                  <div class="status success">
                      <h3>âœ… ì‹œìŠ¤í…œ ìƒíƒœ</h3>
                      <p>í•´ì–‘ ë‚ ì”¨ ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„ ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.</p>
                  </div>
                  
                  <div class="status info">
                      <h3>ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ í˜„í™©</h3>
                      <ul>
                          <li>Stormglass API: âœ… ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘</li>
                          <li>Open-Meteo API: âœ… ì‹¤ì œ ë°ì´í„° ìˆ˜ì§‘</li>
                          <li>NCM Selenium: âœ… ì‹¤ì œ/í´ë°± ë°ì´í„°</li>
                          <li>WorldTides API: âš ï¸ í¬ë ˆë”§ ë¶€ì¡± (í´ë°± ë°ì´í„°)</li>
                      </ul>
                      <p><strong>ì „ì²´ ìˆ˜ì§‘ë¥ : 83.3% (ì‹¤ì œ ë°ì´í„°)</strong></p>
                  </div>
                  
                  <div class="status warning">
                      <h3>ğŸš¢ ìš´í•­ íŒì •</h3>
                      <p>ERI(Environmental Risk Index) ê¸°ë°˜ GO/CONDITIONAL/NO-GO ìë™ ë¶„ë¥˜ ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                      <p>7ê°œ í•´ì–‘ ë³€ìˆ˜ (í’ì†, íŒŒê³ , ìŠ¤ì›°, ë°”ëŒíŒŒ, í•´ë¥˜, ì‹œì •, ì•ˆê°œ)ë¥¼ ì¢…í•© ë¶„ì„í•©ë‹ˆë‹¤.</p>
                  </div>
                  
                  <div class="status info">
                      <h3>ğŸ“‹ ë³´ê³ ì„œ ì •ë³´</h3>
                      <p>ìƒì„¸í•œ 3ì¼ ì˜ˆë³´ ë³´ê³ ì„œëŠ” GitHub Actions ì•„í‹°íŒ©íŠ¸ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                      <p>ë³´ê³ ì„œ í˜•ì‹: JSON, Markdown, CSV ìš”ì•½</p>
                  </div>
                  
                  <div class="footer">
                      <p>HVDC Marine Weather Ingestion System v2.1</p>
                      <p>Powered by MACHO-GPT & GitHub Actions</p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Send Telegram notification
        if: ${{ env.NOTIFY_TELEGRAM == '1' }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode "parse_mode=HTML" \
            --data-urlencode "text@out/summary.txt"

      - name: Send Email notification
        if: ${{ env.NOTIFY_EMAIL == '1' }}
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸŒŠ Marine Weather Report - $(date '+%Y-%m-%d %H:%M')"
          to: ${{ secrets.MAIL_TO }}
          from: "Weather Bot <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://out/summary.html

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: marine-weather-report-${{ github.run_number }}
          path: |
            out/*
            reports/*
            data/*
          retention-days: 7

      - name: Commit and push results (optional)
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add reports/ data/ out/
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-update: Marine weather report $(date '+%Y-%m-%d %H:%M')"
          git push
