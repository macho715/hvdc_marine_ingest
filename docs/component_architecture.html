<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시스템 컴포넌트 아키텍처</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        .diagram-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .component-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #007bff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .component-title {
            color: #007bff;
            font-size: 1.3em;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .file-structure {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧩 시스템 컴포넌트 아키텍처</h1>
        
        <div class="diagram-container">
            <h3>📁 파일 구조 및 모듈 관계</h3>
            <div class="mermaid">
graph TB
    subgraph "프로젝트 루트"
        ROOT["hvdc_marine_ingest/"]
    end
    
    subgraph "데이터 수집 계층"
        NCM["ncm_web/<br/>ncm_selenium_ingestor.py<br/>ncm_web_ingestor.py"]
        CONN["src/marine_ops/connectors/<br/>stormglass.py<br/>open_meteo.py<br/>worldtides.py"]
    end
    
    subgraph "핵심 처리 계층"
        SCHEMA["src/marine_ops/core/<br/>schema.py<br/>units.py<br/>cache.py<br/>vector_db.py"]
        ERI["src/marine_ops/eri/<br/>compute.py"]
        DECISION["src/marine_ops/decision/<br/>fusion.py"]
    end
    
    subgraph "질의 응답 계층"
        QUERY["query_vec.py<br/>MarineQueryEngine"]
        HOOKS["agent_hooks.py<br/>Cursor Browser Controls"]
    end
    
    subgraph "자동화 계층"
        SCRIPTS["scripts/<br/>generate_weather_report.py<br/>cron_automation.py<br/>demo_integrated.py"]
        CONFIG["config/<br/>settings.yaml<br/>eri_rules.yaml<br/>env_template"]
    end
    
    subgraph "데이터 저장소"
        DATA["data/<br/>marine_*.csv"]
        REPORTS["reports/<br/>DEMO_*.json"]
        VECDB["marine_vec.db<br/>SQLite 벡터 DB"]
    end
    
    ROOT --> NCM
    ROOT --> CONN
    ROOT --> SCHEMA
    ROOT --> ERI
    ROOT --> DECISION
    ROOT --> QUERY
    ROOT --> HOOKS
    ROOT --> SCRIPTS
    ROOT --> CONFIG
    
    NCM --> SCHEMA
    CONN --> SCHEMA
    SCHEMA --> ERI
    ERI --> DECISION
    DECISION --> VECDB
    QUERY --> VECDB
    SCRIPTS --> NCM
    SCRIPTS --> CONN
    SCRIPTS --> DATA
    SCRIPTS --> REPORTS
            </div>
        </div>

        <div class="component-grid">
            <div class="component-card">
                <div class="component-title">🔍 NCM 데이터 수집기</div>
                <p><strong>역할</strong>: NCM Al Bahar 해양 관측 페이지에서 실시간 데이터 수집</p>
                <div class="file-structure">
ncm_web/
├── ncm_selenium_ingestor.py
├── ncm_web_ingestor.py
└── __init__.py
                </div>
                <ul>
                    <li>Selenium WebDriver로 동적 페이지 처리</li>
                    <li>테이블 데이터 파싱 및 정규화</li>
                    <li>단위 변환 (kt→m/s, ft→m)</li>
                    <li>벡터 DB 자동 저장</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">🌐 API 커넥터</div>
                <p><strong>역할</strong>: 외부 해양 날씨 API와 통신</p>
                <div class="file-structure">
src/marine_ops/connectors/
├── stormglass.py
├── open_meteo.py
├── worldtides.py
└── __init__.py
                </div>
                <ul>
                    <li>Stormglass: 상용 해양 API</li>
                    <li>Open-Meteo: 오픈소스 날씨 API</li>
                    <li>WorldTides: 조석 데이터 API</li>
                    <li>에러 처리 및 재시도 로직</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">⚙️ 핵심 처리 엔진</div>
                <p><strong>역할</strong>: 데이터 표준화 및 벡터 저장</p>
                <div class="file-structure">
src/marine_ops/core/
├── schema.py
├── units.py
├── cache.py
└── vector_db.py
                </div>
                <ul>
                    <li>MarineDataPoint 스키마 정의</li>
                    <li>SI 단위 변환</li>
                    <li>3시간 TTL 캐시</li>
                    <li>SQLite 벡터 DB 관리</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">📊 ERI 계산 엔진</div>
                <p><strong>역할</strong>: 환경 위험 지수 계산 (0-100)</p>
                <div class="file-structure">
src/marine_ops/eri/
├── compute.py
└── __init__.py
                </div>
                <ul>
                    <li>파고, 풍속 기반 위험도 계산</li>
                    <li>임계값: 파고 1.5m, 풍속 20kt</li>
                    <li>규칙 기반 점수 매핑</li>
                    <li>실시간 모니터링 지원</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">🎯 예보 융합 엔진</div>
                <p><strong>역할</strong>: 다중 소스 예보 통합 및 운항 판정</p>
                <div class="file-structure">
src/marine_ops/decision/
├── fusion.py
└── __init__.py
                </div>
                <ul>
                    <li>NCM 60% + 시스템 40% 가중치</li>
                    <li>GO/CONDITIONAL/NO-GO 판정</li>
                    <li>신뢰도 ≥0.95 요구</li>
                    <li>실시간 알림 트리거</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">🤖 질의 응답 시스템</div>
                <p><strong>역할</strong>: 자연어 질의 처리 및 LLM 분석</p>
                <div class="file-structure">
query_vec.py
agent_hooks.py
                </div>
                <ul>
                    <li>자연어 → 벡터 변환</li>
                    <li>KNN 유사도 검색</li>
                    <li>Cursor Browser Controls 훅</li>
                    <li>구조화된 답변 생성</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">⏰ 자동화 스케줄러</div>
                <p><strong>역할</strong>: 주기적 데이터 수집 및 보고서 생성</p>
                <div class="file-structure">
scripts/
├── generate_weather_report.py
├── cron_automation.py
├── demo_integrated.py
└── test_vector_pipeline.py
                </div>
                <ul>
                    <li>3시간마다 데이터 수집</li>
                    <li>06:00/18:00 보고서 생성</li>
                    <li>Telegram/Email 알림</li>
                    <li>헬스체크 및 에러 복구</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">⚙️ 설정 관리</div>
                <p><strong>역할</strong>: 시스템 설정 및 규칙 관리</p>
                <div class="file-structure">
config/
├── settings.yaml
├── eri_rules.yaml
└── env_template
                </div>
                <ul>
                    <li>API 키 및 엔드포인트</li>
                    <li>ERI 계산 규칙</li>
                    <li>임계값 및 가중치</li>
                    <li>알림 설정</li>
                </ul>
            </div>

            <div class="component-card">
                <div class="component-title">💾 데이터 저장소</div>
                <p><strong>역할</strong>: 수집된 데이터 및 벡터 저장</p>
                <div class="file-structure">
data/
├── marine_*.csv
└── marine_vec.db

reports/
└── DEMO_*.json
                </div>
                <ul>
                    <li>SQLite 벡터 DB (384차원)</li>
                    <li>CSV 형태 원본 데이터</li>
                    <li>JSON 형태 보고서</li>
                    <li>메타데이터 관리</li>
                </ul>
            </div>
        </div>

        <div class="diagram-container">
            <h3>🔄 데이터 플로우 시퀀스</h3>
            <div class="mermaid">
sequenceDiagram
    participant U as 사용자
    participant S as 스케줄러
    participant N as NCM 수집기
    participant A as API 커넥터
    participant E as ERI 엔진
    participant D as 융합 엔진
    participant V as 벡터 DB
    participant Q as 질의 엔진
    participant L as LLM
    
    Note over S: 매 3시간마다 실행
    S->>N: 데이터 수집 요청
    N->>N: Selenium 크롤링
    N->>A: 외부 API 호출
    A->>N: 해양 데이터 반환
    N->>E: 데이터 전달
    E->>E: ERI 계산 (0-100)
    E->>D: 위험 지수 전달
    D->>D: 다중 소스 융합
    D->>D: 운항 판정 (GO/COND/NO-GO)
    D->>V: 결과 저장
    V->>V: 벡터 임베딩 생성
    
    Note over U: 자연어 질의
    U->>Q: "AGI high tide RORO window"
    Q->>V: 벡터 검색
    V->>Q: 유사 데이터 반환
    Q->>L: LLM 분석 요청
    L->>Q: 구조화된 답변
    Q->>U: 운항 조건 리포트
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true
            }
        });
    </script>
</body>
</html>
